---
import Button from "../ui/Button";
import type { ButtonSize } from "../ui/Button";
import Checkmark from "../../assets/icons/Checkmark.svg";
interface Props {
  name: string;
  submitButtonText?: string;
  successMessage?: string;
  size?: "md" | string;
}

const {
  name,
  submitButtonText = "Submit",
  successMessage = "Thank you! Your form has been submitted successfully.",
  size = "md",
} = Astro.props;

type Size = "sm" | "md" | "lg";
const sizes: Record<Size, string> = {
  sm: "p-4",
  md: "p-5 md:p-10",
  lg: "p-5 md:p-10 lg:p-12 xl:p-14",
};
---

<style>
  .your-website-here {
    display: none;
  }
</style>
<div
  class={`bg-surface-secondary rounded-lg shadow-lg mx-auto w-full ${sizes[size as Size]}`}
>
  <!-- Success Message -->
  <div
    id="success-message"
    class="hidden mb-4 p-4 bg-success-light rounded-md flex items-center space-x-2"
  >
    <Checkmark />
    <span class="text-success-content font-sans">
      {successMessage}
    </span>
  </div>

  <!-- Netlify Form Configuration
       - data-netlify="true" enables Netlify form handling
       - netlify-honeypot adds spam protection
       - data-form-name is used for JS form handling
  -->
  <form
    method="POST"
    name={name}
    id={name}
    class="space-y-4"
    data-form-name={name}
    data-netlify="true"
    netlify-honeypot="url-field"
  >
    <!-- Required hidden field for Netlify forms -->
    <input type="hidden" name="form-name" value={name} />

    <!-- Hidden field to track form submission source URL -->
    <input type="hidden" name="url" value={Astro.url.toString()} />

    <!-- Honeypot field to catch spam bots -->
    <p class="your-website-here">
      <label for="url-field">URL</label>
      <input type="url" name="url-field" id="url-field" />
    </p>

    <!-- Custom form fields injected via slot -->
    <slot />

    <!-- Submit button -->
    <Button type="submit" variant="primary" size={size as ButtonSize}>
      {submitButtonText}
    </Button>
  </form>
</div>
<script>
  // @ts-nocheck
  const handleSubmit = (event) => {
    event.preventDefault();

    const myForm = event.target;
    const formData = new FormData(myForm);
    const successMessage =
      myForm.parentElement?.querySelector("#success-message");

    // Submit to Netlify forms endpoint
    // Note: CORS error is expected but can be ignored as submission still works
    fetch("https://extraordinary-sherbet-37382c.netlify.app", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(formData.entries()).toString(),
    }).finally(() => {
      myForm.reset();

      // Show success message
      if (successMessage) {
        successMessage.classList.remove("hidden");

        // Hide success message after 5 seconds
        setTimeout(() => {
          successMessage.classList.add("hidden");
        }, 5000);
      }
    });
  };

  // @ts-ignore
  // Get all forms and attach event listeners
  document.querySelectorAll("form[data-form-name]").forEach((form) => {
    form.addEventListener("submit", handleSubmit);
  });
</script>
