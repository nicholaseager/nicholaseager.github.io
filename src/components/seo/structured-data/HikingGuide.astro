---
import { type CollectionEntry } from "astro:content";
import gear from "../../../data/gear.json";

interface Props {
  guide: CollectionEntry<"guides">["data"];
}

const { guide } = Astro.props;
const currentPageCanonicalURL = new URL(Astro.url.pathname, Astro.site);
const authorName = "Nicholas Eager";
const authorURL = new URL("/about", Astro.site);

const tools = guide.gear?.trip
  ? gear.filter((g) => g.trips.includes(guide.gear!.trip))
  : [];

const jsonLd = {
  "@context": "https://schema.org",
  "@type": ["HowTo", "Article", "CreativeWork", "Guide"],
  name: guide.title,
  headline: guide.title,
  abstract: guide.introduction,
  description: guide.introduction,
  url: currentPageCanonicalURL.toString(),
  datePublished: guide.date,
  dateModified: guide.modified_date,
  audience: {
    "@type": "Audience",
    audienceType: "Intermediate Hikers",
  },
  educationalLevel: "Intermediate",
  author: {
    "@type": "Person",
    name: authorName,
    url: authorURL,
  },
  image: {
    "@type": "ImageObject",
    url: new URL(
      guide.image + ".jpg",
      "https://ik.imagekit.io/qn1gkawvy/tr:w-1280/"
    ).toString(),
    height: "1280",
    width: "1280",
    caption: `Main image for ${guide.title}`,
  },
  // TODO
  contentLocation: {
    "@type": "Place",
    name: "Mount Example Trail",
    address: {
      "@type": "PostalAddress",
      addressLocality: "Example City",
      addressRegion: "State",
      addressCountry: "US",
    },
    geo: {
      "@type": "GeoCoordinates",
      latitude: "27.7103",
      longitude: "85.3222",
      elevation: "3500 m",
    },
    ...(guide.map && {
      map: `https://www.google.com/maps/d/viewer?mid=${guide.map.id}`,
    }),
  },
  // TODO
  totalTime: "P21D", // ISO 8601 duration format for 21 days
  ...(guide.itinerary && {
    step: guide.itinerary.phases.map((phase, index) => {
      return {
        "@type": "HowToStep",
        name: `${guide.itinerary?.units?.phase ?? "Day"} ${index + 1}: ${phase.title}`,
        text: phase.description,
        ...(phase.images &&
          phase.images.length > 0 && {
            image: {
              "@type": "ImageObject",
              url: new URL(
                phase.images[0] + ".jpg",
                "https://ik.imagekit.io/qn1gkawvy/tr:w-1280/"
              ).toString(),
              height: "1280",
              width: "1280",
              caption: `Image for ${phase.title}`,
            },
          }),
      };
    }),
  }),
  tool: tools.map((tool) => {
    return {
      "@type": "HowToTool",
      name: tool.title,
      url: tool.url,
    };
  }),
  // TODO
  estimatedCost: {
    "@type": "MonetaryAmount",
    currency: "USD",
    value: "2000",
  },
};
---

<script
  is:inline
  type="application/ld+json"
  set:html={JSON.stringify(jsonLd)}
/>
